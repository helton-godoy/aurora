#!/bin/bash
# ==============================================================================
# AURORA - Instalador de Depend√™ncias
# ==============================================================================

set -euo pipefail

# ============================================================================
# FUN√á√ïES DE VERIFICA√á√ÉO
# ============================================================================

check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo "‚ùå Erro: Este script deve ser executado como root"
        echo ""
        echo "Execute: sudo $0"
        exit 1
    fi
}

check_debian() {
    if [[ ! -f /etc/debian_version ]] && [[ ! -f /etc/os-release ]]; then
        echo "‚ùå Erro: Sistema n√£o suportado (requer Debian ou baseado em Debian)"
        exit 1
    fi
}

# ============================================================================
# FUN√á√ïES DE INSTALA√á√ÉO
# ============================================================================

update_system() {
    echo "üîÑ Atualizando reposit√≥rios..."
    apt-get update -qq
    echo "‚úÖ Reposit√≥rios atualizados"
}

install_yq() {
    if command -v yq &>/dev/null; then
        echo "‚úÖ yq j√° instalado"
        return 0
    fi

    echo "üì¶ Instalando yq (parser YAML)..."

    # Tentar instalar via pip
    if command -v pip3 &>/dev/null; then
        pip3 install yq -q
        echo "‚úÖ yq instalado via pip3"
        return 0
    fi

    # Fallback: baixar bin√°rio
    local yq_url="https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64"
    local yq_bin="/usr/local/bin/yq"

    curl -fsSL "$yq_url" -o "$yq_bin"
    chmod +x "$yq_bin"
    echo "‚úÖ yq instalado como bin√°rio"
}

install_gum() {
    if command -v gum &>/dev/null; then
        echo "‚úÖ gum j√° instalado"
        return 0
    fi

    echo "üì¶ Instalando gum..."

    # Adicionar reposit√≥rio Charm
    mkdir -p /etc/apt/keyrings
    curl -fsSL https://repo.charm.sh/apt/gpg.key | gpg --dearmor -o /etc/apt/keyrings/charm.gpg
    echo "deb [signed-by=/etc/apt/keyrings/charm.gpg] https://repo.charm.sh/apt/ * *" | tee /etc/apt/sources.list.d/charm.list >/dev/null

    apt-get update -qq
    apt-get install -y gum

    echo "‚úÖ gum instalado"
}

install_starship() {
    if command -v starship &>/dev/null; then
        echo "‚úÖ starship j√° instalado"
        return 0
    fi

    echo "üì¶ Instalando Starship..."

    curl -fsSL https://starship.rs/install.sh | sh -s -- --bin-dir /usr/local/bin -y

    echo "‚úÖ Starship instalado"
}

install_kmscon() {
    if command -v kmscon &>/dev/null; then
        echo "‚úÖ kmscon j√° instalado"
        return 0
    fi

    echo "üì¶ Instalando kmscon (terminal para servidores headless)..."

    apt-get install -y kmscon

    echo "‚úÖ kmscon instalado"
}

install_nerd_font() {
    # Verificar se j√° existe fonte Nerd
    if fc-list 2>/dev/null | grep -qi "firacode.*nerd\|hack.*nerd\|jetbrains.*mono.*nerd"; then
        local installed_font
        installed_font=$(fc-list 2>/dev/null | grep -i "nerd" | head -1 | cut -d: -f2 | sed 's/^ *//')
        echo "‚úÖ Fonte Nerd j√° instalada: $installed_font"
        return 0
    fi

    echo "üì¶ Instalando FiraCode Nerd Font..."

    local font_cache="/tmp/aurora-fonts"
    mkdir -p "$font_cache"

    # Tentar instalar v√°rias fontes Nerd em ordem de prefer√™ncia
    local fonts=(
        "FiraCode:FiraCode.zip:https://github.com/ryanoasis/nerd-fonts/releases/latest/download/FiraCode.zip"
        "Hack:Hack.zip:https://github.com/ryanoasis/nerd-fonts/releases/latest/download/Hack.zip"
        "JetBrainsMono:JetBrainsMono.zip:https://github.com/ryanoasis/nerd-fonts/releases/latest/download/JetBrainsMono.zip"
    )

    for font_info in "${fonts[@]}"; do
        IFS=':' read -r font_name zip_name font_url <<<"$font_info"

        echo "   Tentando $font_name..."

        rm -rf "$font_cache"/*
        if curl_output=$(curl -fsSL --connect-timeout 15 --max-time 30 "$font_url" -o "$font_cache/$zip_name" 2>&1); then
            if unzip -oq "$font_cache/$zip_name" -d "$font_cache" 2>/dev/null; then
                local font_dir="/usr/local/share/fonts"
                mkdir -p "$font_dir"

                # Copiar arquivos .ttf
                find "$font_cache" -name "*.ttf" -exec cp {} "$font_dir/" \; 2>/dev/null || true

                if fc-cache -fv >/dev/null 2>&1; then
                    sleep 1
                    if fc-list 2>/dev/null | grep -qi "$font_name.*nerd"; then
                        rm -rf "$font_cache"
                        echo "‚úÖ $font_name Nerd Font instalado"
                        return 0
                    fi
                fi
            else
            echo "   ‚ùå Erro no download: $(echo "$curl_output" | head -1)"
        fi
        fi
    done

    # Fallback: tentar via apt
    echo "   Tentando instala√ß√£o via apt..."
    local apt_fonts=("fonts-firacode" "fonts-hack" "fonts-jetbrains-mono")

    for apt_font in "${apt_fonts[@]}"; do
        if apt-cache show "$apt_font" >/dev/null 2>&1; then
            if apt-get install -y "$apt_font" >/dev/null 2>&1; then
                fc-cache -fv >/dev/null 2>&1
                sleep 1
                if fc-list 2>/dev/null | grep -qi "nerd\|firacode\|hack\|jetbrains.*mono"; then
                    rm -rf "$font_cache"
                    echo "‚úÖ Fonte instalada via apt: $apt_font"
                    return 0
                fi
            fi
        fi
    done

    rm -rf "$font_cache"
    echo "‚ö† Aviso: Fonte Nerd n√£o instalada, funcionalidade de √≠cones reduzida"
    return 1
}

setup_aurora_dirs() {
    echo "üìÅ Criando diret√≥rios do Aurora..."

    # Diret√≥rio de temas do sistema
    mkdir -p /etc/aurora/themes
    mkdir -p /etc/aurora/config

    # Diret√≥rio de configura√ß√£o do usu√°rio
    mkdir -p "$HOME/.config/aurora"

    echo "‚úÖ Diret√≥rios criados"
}

# ============================================================================
# FUN√á√ÉO PRINCIPAL
# ============================================================================

main() {
    clear
    cat << 'BANNER'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë           üç´ AURORA - INSTALADOR DE DEPEND√äNCIAS            ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
BANNER

    echo ""
    echo "Este script ir√° instalar as depend√™ncias necess√°rias para o Aurora."
    echo ""

    # Verifica√ß√µes
    check_debian

    echo "üîç Verificando privil√©gios..."
    if [[ $EUID -eq 0 ]]; then
        echo "‚úÖ Executando como root"
    else
        echo "‚ö† Aviso: Alguns pacotes podem requerer sudo"
    fi
    echo ""

    # Atualizar sistema
    update_system
    echo ""

    # Instalar depend√™ncias
    echo "üì¶ Instalando depend√™ncias..."
    echo ""

    install_yq
    install_gum
    install_starship
    install_kmscon
    install_nerd_font
    echo ""

    # Configurar aurora
    setup_aurora_dirs
    echo ""

    # Finaliza√ß√£o
    cat << 'FINAL'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                ‚úÖ INSTALA√á√ÉO CONCLU√çDA                      ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

Pr√≥ximos passos:
  ‚Ä¢ Execute 'aurora list' para ver temas dispon√≠veis
  ‚Ä¢ Execute 'aurora preview <tema>' para visualizar um tema
  ‚Ä¢ Execute 'aurora apply <tema>' para aplicar um tema
  ‚Ä¢ Execute 'aurora install-hooks' para configurar os shells

Para mais informa√ß√µes:
  ‚Ä¢ aurora help
FINAL

    return 0
}

main "$@"
