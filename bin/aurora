#!/bin/bash
# ==============================================================================
# AURORA - CLI Principal v3.0
# Gerenciador de Temas Visuais Multi-Shell
# ==============================================================================

set -euo pipefail

# ============================================================================
# INICIALIZAÃ‡ÃƒO
# ============================================================================

# Detectar root do projeto
AURORA_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export AURORA_ROOT

# Carregar todos os mÃ³dulos
source "$AURORA_ROOT/src/config/loader.sh"

# ============================================================================
# FUNÃ‡Ã•ES DE VALIDAÃ‡ÃƒO
# ============================================================================

check_dependencies() {
    local missing_deps=()

    # Verificar dependÃªncias obrigatÃ³rias
    if ! command -v yq &>/dev/null; then
        missing_deps+=("yq (parser YAML)")
    fi

    # Verificar dependÃªncias opcionais
    if ! command -v gum &>/dev/null; then
        echo "âš  Aviso: 'gum' nÃ£o instalado - UI bÃ¡sica serÃ¡ usada"
    else
        # gum estÃ¡ instalado, verificar se hÃ¡ TTY
        if ! [[ -t 1 ]] && ! [[ -t 0 ]]; then
            echo "â„¹ Modo nÃ£o-interativo detectado - UI simplificada"
        fi
    fi

    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        echo "âŒ Erro: DependÃªncias faltando:"
        for dep in "${missing_deps[@]}"; do
            echo "   - $dep"
        done
        echo ""
        echo "Instale com: sudo apt install yq"
        exit 1
    fi
}

# ============================================================================
# FUNÃ‡Ã•ES PRINCIPAIS
# ============================================================================

show_help() {
    clear
    cat << 'HELP_EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                       ğŸ« AURORA v3.0                              â•‘
â•‘            Gerenciador de Temas Visuais Multi-Shell              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                       â•‘
â•‘  ğŸ“š COMANDOS DISPONÃVEIS:                                          â•‘
â•‘                                                                       â•‘
â•‘  aurora list                    - Listar temas disponÃ­veis          â•‘
â•‘  aurora list --remote           - Listar temas no repositÃ³rio     â•‘
â•‘  aurora preview <tema>          - Visualizar tema temporariamente  â•‘
â•‘  aurora apply <tema>            - Aplicar tema permanentemente   â•‘
â•‘  aurora install <tema_remoto>  - Instalar tema do repositÃ³rio    â•‘
â•‘  aurora remove <tema>            - Remover tema local             â•‘
â•‘  aurora install-hooks           - Instalar hooks nos shells      â•‘
â•‘  aurora status                  - Mostrar status do sistema      â•‘
â•‘  aurora backup [list|restore]   - Gerenciar backups            â•‘
â•‘  aurora help                    - Mostrar esta ajuda           â•‘
â•‘                                                                       â•‘
â•‘  ğŸ”§ MULTI-SHELL SUPPORT:                                             â•‘
â•‘  aurora suporta Bash, Zsh e Fish                                    â•‘
â•‘                                                                       â•‘
â•‘  ğŸ–¥ KMSCON SUPPORT:                                                 â•‘
â•‘  Suporte especial para terminais kmscon em servidores headless         â•‘
â•‘                                                                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
HELP_EOF
}

# Listar temas locais
cmd_list() {
    local remote_flag="${1:-}"

    if [[ "$remote_flag" == "--remote" ]]; then
        list_remote_themes
    else
        list_themes
    fi
}

# Preview de tema
cmd_preview() {
    local theme_name="${2:-}"

    if [[ -z "$theme_name" ]]; then
        echo "âŒ Erro: Nome do tema nÃ£o fornecido"
        echo ""
        echo "Uso: aurora preview <nome_tema>"
        exit 1
    fi

    # Carregar tema
    if ! load_theme "$theme_name"; then
        exit 1
    fi

    # Limpar tela
    clear

    # Aplicar cores ao terminal
    apply_theme_terminal

    # Mostrar preview
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  ğŸ¨ PREVIEW: $THEME_NAME"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "  ğŸ“ DescriÃ§Ã£o: $THEME_DESCRIPTION"
    echo ""
    echo "  ğŸ¨ Cores:"
    echo "     Background:  $THEME_BG"
    echo "     Foreground:  $THEME_FG"
    echo "     Accent:      $THEME_ACCENT"
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "  ğŸ“„ Exemplo de texto:"
    echo ""
    echo "     Normal: Este Ã© um texto normal"
    echo "     Destaque: Texto com $(tput setaf 3)destaque$(tput sgr0)"
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "  â± Preview ativo por 10 segundos... Pressione qualquer tecla para sair"
    echo ""

    # Aguardar ou timeout
    read -t 10 -n 1 2>/dev/null || true

    # Resetar cores
    echo -ne "\033]111\007" # Reset background
    echo -ne "\033]110\007" # Reset foreground
    echo -ne "\033[0m" # Reset all

    clear
    echo "âœ… Preview finalizado"

    return 0
}

# Aplicar tema permanentemente
cmd_apply() {
    local theme_name="${2:-}"

    if [[ -z "$theme_name" ]]; then
        echo "âŒ Erro: Nome do tema nÃ£o fornecido"
        echo ""
        echo "Uso: aurora apply <nome_tema>"
        exit 1
    fi

    # Carregar tema
    if ! load_theme "$theme_name"; then
        exit 1
    fi

    echo "ğŸ”„ Aplicando tema: $THEME_NAME..."

    # Backup do estado atual
    backup_file "$STATE_FILE"

    # Salvar novo estado
    save_state "$theme_name"

    # Aplicar ao terminal
    apply_theme_terminal

    # Aplicar ao kmscon se disponÃ­vel
    kmscon_apply_theme

    # Aplicar hooks de shell
    if [[ -f "$AURORA_ROOT/src/modules/hooks.sh" ]]; then
        install_shell_hooks
    fi

    echo ""
    echo "âœ… Tema '$THEME_NAME' aplicado com sucesso!"
    echo ""
    echo "ğŸ“‹ Para ver as mudanÃ§as:"
    echo "   â€¢ Reinicie o terminal ou execute: source ~/.bashrc (ou ~/.zshrc)"
    echo "   â€¢ Se estiver usando kmscon, reinicie o serviÃ§o: sudo systemctl restart kmscon"

    return 0
}

# Instalar tema remoto
cmd_install() {
    local theme_name="${2:-}"

    if [[ -z "$theme_name" ]]; then
        echo "âŒ Erro: Nome do tema nÃ£o fornecido"
        echo ""
        echo "Uso: aurora install <nome_tema>"
        echo ""
        echo "ğŸ’¡ Veja temas disponÃ­veis com: aurora list --remote"
        exit 1
    fi

    if ! fetch_remote_theme "$theme_name"; then
        exit 1
    fi
}

# Remover tema local
cmd_remove() {
    local theme_name="${2:-}"

    if [[ -z "$theme_name" ]]; then
        echo "âŒ Erro: Nome do tema nÃ£o fornecido"
        echo ""
        echo "Uso: aurora remove <nome_tema>"
        echo ""
        echo "ğŸ’¡ Veja temas instalados com: aurora list"
        exit 1
    fi

    if ! remove_theme "$theme_name"; then
        exit 1
    fi
}

# Instalar hooks de shell
cmd_install_hooks() {
    if [[ -f "$AURORA_ROOT/src/modules/hooks.sh" ]]; then
        install_shell_hooks
        echo "âœ… Hooks instalados!"
    else
        echo "âŒ Erro: MÃ³dulo hooks.sh nÃ£o encontrado"
        exit 1
    fi
}

# Mostrar status
cmd_status() {
    clear
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  ğŸ“Š STATUS DO AURORA"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    # Tema atual
    local current_theme
    current_theme=$(load_state)

    if [[ -n "$current_theme" ]]; then
        echo "  ğŸ¨ Tema Ativo: $current_theme"
    else
        echo "  âš  Nenhum tema aplicado"
    fi
    echo ""

    # DependÃªncias
    echo "  ğŸ“¦ DependÃªncias:"
    if command -v yq &>/dev/null; then
        echo "     âœ“ yq instalado"
    else
        echo "     âœ— yq nÃ£o instalado"
    fi

    if command -v gum &>/dev/null; then
        echo "     âœ“ gum instalado"
    else
        echo "     âš  gum nÃ£o instalado (opcional)"
    fi

    if command -v starship &>/dev/null; then
        local starship_ver
        starship_ver=$(starship --version 2>/dev/null | head -1)
        echo "     âœ“ starship instalado ($starship_ver)"
    else
        echo "     âš  starship nÃ£o instalado (opcional)"
    fi
    echo ""

    # Ambiente
    echo "  ğŸ–¥ Ambiente:"
    if is_kmscon; then
        echo "     âœ“ Kmscon detectado"
    else
        echo "     â„¹ Terminal padrÃ£o (nÃ£o-kmscon)"
    fi

    echo "     Shell: $SHELL"
    echo ""

    # DiretÃ³rios
    echo "  ğŸ“ DiretÃ³rios:"
    echo "     Raiz:     $AURORA_ROOT"
    echo "     Temas:    $THEME_DIR"
    echo "     Config:   $CONFIG_DIR"
    echo ""

    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
}

# Gerenciar backups
cmd_backup() {
    local action="${2:-list}"

    case "$action" in
        list)
            list_backups
            ;;
        restore)
            local backup_file="${3:-}"

            if [[ -z "$backup_file" ]]; then
                echo "âŒ Erro: Arquivo de backup nÃ£o especificado"
                echo ""
                echo "Uso: aurora backup restore <arquivo_backup>"
                echo ""
                echo "ğŸ’¡ Veja backups disponÃ­veis com: aurora backup list"
                exit 1
            fi

            restore_backup "$backup_file" "$STATE_FILE"
            ;;
        *)
            echo "âŒ Erro: AÃ§Ã£o invÃ¡lida '$action'"
            echo ""
            echo "Uso: aurora backup [list|restore]"
            echo ""
            echo "  list    - Listar backups disponÃ­veis"
            echo "  restore - Restaurar backup especÃ­fico"
            exit 1
            ;;
    esac
}

# ============================================================================
# FUNÃ‡ÃƒO PRINCIPAL
# ============================================================================

main() {
    # Verificar dependÃªncias
    check_dependencies

    # Roteamento de comandos
    case "${1:-help}" in
        list)
            cmd_list "$2"
            ;;
        preview)
            cmd_preview "$@"
            ;;
        apply)
            cmd_apply "$@"
            ;;
        install)
            cmd_install "$@"
            ;;
        remove)
            cmd_remove "$@"
            ;;
        install-hooks)
            cmd_install_hooks
            ;;
        status)
            cmd_status
            ;;
        backup)
            cmd_backup "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo "âŒ Erro: Comando desconhecido '$1'"
            echo ""
            echo "ğŸ’¡ Use 'aurora help' para ver comandos disponÃ­veis"
            exit 1
            ;;
    esac
}

# Executar
main "$@"
