#!/bin/bash
# ==============================================================================
# AURORA - Instalador de Depend√™ncias
# ==============================================================================

set -euo pipefail

# ============================================================================
# FUN√á√ïES DE VERIFICA√á√ÉO
# ============================================================================

check_root() {
	if [[ $EUID -ne 0 ]]; then
		echo "‚ùå Erro: Este script deve ser executado como root"
		echo ""
		echo "Execute: sudo $0"
		exit 1
	fi
}

check_debian() {
	if [[ ! -f /etc/debian_version ]] && [[ ! -f /etc/os-release ]]; then
		echo "‚ùå Erro: Sistema n√£o suportado (requer Debian ou baseado em Debian)"
		exit 1
	fi
}

# ============================================================================
# FUN√á√ïES DE INSTALA√á√ÉO
# ============================================================================

update_system() {
	echo "üîÑ Atualizando reposit√≥rios..."
	apt-get update -qq
	echo "‚úÖ Reposit√≥rios atualizados"
}

install_yq() {
	if command -v yq &>/dev/null; then
		echo "‚úÖ yq j√° instalado"
		return 0
	fi

	echo "üì¶ Instalando yq (parser YAML)..."

	if command -v pip3 &>/dev/null; then
		pip3 install yq -q
		echo "‚úÖ yq instalado via pip3"
		return 0
	fi

	local yq_url="https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64"
	local yq_bin="/usr/local/bin/yq"

	curl -fsSL "$yq_url" -o "$yq_bin"
	chmod +x "$yq_bin"
	echo "‚úÖ yq instalado como bin√°rio"
}

install_gum() {
	if command -v gum &>/dev/null; then
		echo "‚úÖ gum j√° instalado"
		return 0
	fi

	echo "üì¶ Instalando gum..."

	mkdir -p /etc/apt/keyrings
	curl -fsSL https://repo.charm.sh/apt/gpg.key | gpg --dearmor -o /etc/apt/keyrings/charm.gpg
	echo "deb [signed-by=/etc/apt/keyrings/charm.gpg] https://repo.charm.sh/apt/ * *" | tee /etc/apt/sources.list.d/charm.list >/dev/null

	apt-get update -qq
	apt-get install -y gum

	echo "‚úÖ gum instalado"
}

install_starship() {
	if command -v starship &>/dev/null; then
		echo "‚úÖ starship j√° instalado"
		return 0
	fi

	echo "üì¶ Instalando Starship..."

	curl -fsSL https://starship.rs/install.sh | sh -s -- --bin-dir /usr/local/bin -y

	echo "‚úÖ Starship instalado"
}

install_kmscon() {
	if command -v kmscon &>/dev/null; then
		echo "‚úÖ kmscon j√° instalado"
		return 0
	fi

	echo "üì¶ Instalando kmscon (terminal para servidores headless)..."

	apt-get install -y kmscon

	echo "‚úÖ kmscon instalado"
}

log_error() {
	echo "‚ùå Erro: $1"
}

log_success() {
	echo "‚úÖ $1"
}

log_info() {
	echo "‚ÑπÔ∏è  $1"
}

detect_existing_nerd_fonts() {
	if fc-list 2>/dev/null | grep -qi "firacode.*nerd\|hack.*nerd\|jetbrains.*nerd\|nerd.*font\|cascadia.*nerd\|source.*code.*pro.*nerd"; then
		return 0
	fi

	local font_dirs=()
	[[ -d "/usr/local/share/fonts" ]] && font_dirs+=("/usr/local/share/fonts")
	[[ -d "/usr/share/fonts" ]] && font_dirs+=("/usr/share/fonts")
	[[ -d "$HOME/.local/share/fonts" ]] && font_dirs+=("$HOME/.local/share/fonts")
	[[ -d "$HOME/.fonts" ]] && font_dirs+=("$HOME/.fonts")

	for dir in "${font_dirs[@]}"; do
		if find "$dir" -maxdepth 1 -name "*Nerd*.ttf" 2>/dev/null | head -1 | grep -q "."; then
			return 0
		fi
	done

	local nerd_count
	nerd_count=$(fc-list 2>/dev/null | grep -ic "nerd" 2>/dev/null || echo "0")
	if [[ "$nerd_count" -gt 20 ]]; then
		return 0
	fi

	return 1
}

setup_aurora_dirs() {
	echo "üìÅ Criando diret√≥rios do Aurora..."

	local xdg_config_home="${XDG_CONFIG_HOME:-$HOME/.config}"
	local xdg_data_home="${XDG_DATA_HOME:-$HOME/.local/share}"
	local xdg_state_home="${XDG_STATE_HOME:-$HOME/.local/state}"

	# Diret√≥rio de configura√ß√£o global
	mkdir -p /etc/aurora

	# Diret√≥rios do usu√°rio (XDG)
	mkdir -p "$xdg_config_home/aurora"
	mkdir -p "$xdg_data_home/aurora/themes"
	mkdir -p "$xdg_data_home/aurora/backups"
	mkdir -p "$xdg_state_home/aurora"

	echo "‚úÖ Diret√≥rios criados"
}

install_nerd_fonts_from_sources() {
	log_info "Instalando FiraCode Nerd Font..."

	local font_cache="/tmp/aurora-fonts-$$"
	mkdir -p "$font_cache"

	local fonts=(
	    "FiraCode:FiraCode.zip:https://github.com/ryanoasis/nerd-fonts/releases/latest/download/FiraCode.zip"
	    "Hack:Hack.zip:https://github.com/ryanoasis/nerd-fonts/releases/latest/download/Hack.zip"
	    "JetBrainsMono:JetBrainsMono.zip:https://github.com/ryanoasis/nerd-fonts/releases/latest/download/JetBrainsMono.zip"
	)

	for font_info in "${fonts[@]}"; do
	    IFS=':' read -r font_name zip_name font_url <<<"$font_info"
	    
	    if download_and_install_font "$font_name" "$zip_name" "$font_url" "$font_cache"; then
	        rm -rf "${font_cache:?}"
	        return 0
	    fi
	done

	if install_via_apt_fallback "$font_cache"; then
	    return 0
	fi

	rm -rf "${font_cache:?}"
	log_error "Fonte Nerd n√£o instalada, funcionalidade de √≠cones reduzida"
	return 1
}

download_and_install_font() {
	local font_name="$1"
	local zip_name="$2"
	local font_url="$3"
	local font_cache="$4"
	
	log_info "Tentando $font_name..."
	
	rm -rf "${font_cache:?}"/*
	
	if curl_output=$(curl -fsSL --connect-timeout 15 --max-time 30 "$font_url" -o "$font_cache/$zip_name" 2>&1); then
	    if unzip -oq "$font_cache/$zip_name" -d "$font_cache" 2>/dev/null; then
	        local font_dir="/usr/local/share/fonts"
	        mkdir -p "$font_dir"
	        find "$font_cache" -name "*.ttf" -exec cp {} "$font_dir/" \; 2>/dev/null || true
	        
	        if fc-cache -fv >/dev/null 2>&1; then
	            sleep 1
	            if fc-list 2>/dev/null | grep -qi "$font_name.*nerd"; then
	                log_success "$font_name Nerd Font instalado"
	                return 0
	            else
	                log_error "Fonte $font_name n√£o detectada ap√≥s instala√ß√£o"
	            fi
	        else
	            log_error "Falha ao atualizar cache de fontes"
	        fi
	    else
	        log_error "Erro no unzip: arquivos corrompidos ou inv√°lidos"
	    fi
	else
	    log_error "Erro no download: $(echo "$curl_output" | head -1)"
	fi
	
	return 1
}

install_via_apt_fallback() {
	local font_cache="$1"
	
	log_info "Tentando instala√ß√£o via apt..."
	local apt_fonts=("fonts-firacode" "fonts-hack" "fonts-jetbrains-mono")
	
	for apt_font in "${apt_fonts[@]}"; do
	    if apt-cache show "$apt_font" >/dev/null 2>&1; then
	        if apt-get install -y "$apt_font" >/dev/null 2>&1; then
	            fc-cache -fv >/dev/null 2>&1
	            sleep 1
	            if fc-list 2>/dev/null | grep -qi "nerd\|firacode\|hack\|jetbrains.*nerd"; then
	                rm -rf "${font_cache:?}"
	                log_success "Fonte instalada via apt: $apt_font"
	                return 0
	            fi
	        fi
	    fi
	done
	
	return 1
}

# ============================================================================
# FUN√á√ÉO PRINCIPAL
# ============================================================================

main() {
	clear
 	gum style \
		--border rounded \
		--border-foreground "#6a4928" \
		--padding "1 2" \
		--width 60 \
		--align center \
		"$(gum style --foreground "#6a4928" --bold "üç´ AURORA - INSTALADOR DE DEPEND√äNCIAS")"

	echo ""
	echo "Este script ir√° instalar as depend√™ncias necess√°rias para o Aurora."
	echo ""

	check_debian

	echo "üîç Verificando privil√©gios..."
	if [[ $EUID -eq 0 ]]; then
		echo "‚úÖ Executando como root"
	else
		echo "‚ö† Aviso: Alguns pacotes podem requerer sudo"
	fi
	echo ""

	update_system
	echo ""

	echo "üì¶ Instalando depend√™ncias..."
	echo ""

	install_yq
	install_gum
	install_starship
	install_kmscon
	
	if detect_existing_nerd_fonts; then
		log_success "Fontes Nerd j√° detectadas no sistema"
	else
		log_info "Fontes Nerd n√£o detectadas, instalando..."
		install_nerd_fonts_from_sources
	fi
	echo ""

	setup_aurora_dirs
	echo ""

	install_aurora_binary
	echo ""
 
 	gum style \
		--border rounded \
		--border-foreground "#26a048" \
		--padding "1 2" \
		--width 60 \
		--align center \
		"$(gum style --foreground "#26a048" --bold "‚úÖ INSTALA√á√ÉO CONCLU√çDA")" \
		"" \
		"Pr√≥ximos passos:" \
		"  ‚Ä¢ Execute 'aurora list' para ver temas dispon√≠veis" \
		"  ‚Ä¢ Execute 'aurora preview <tema>' para visualizar um tema" \
		"  ‚Ä¢ Execute 'aurora apply <tema>' para aplicar um tema" \
		"  ‚Ä¢ Execute 'aurora install-hooks' para configurar os shells" \
		"" \
		"Para mais informa√ß√µes:" \
		"  ‚Ä¢ aurora help"

	return 0
}

install_aurora_binary() {
	local script_path="${BASH_SOURCE[0]}"
	local install_dir="$(dirname "$script_path")"
	local project_root="$(dirname "$install_dir")"
	local aurora_bin="/usr/local/bin/aurora"
	local system_dir="/usr/local/share/aurora"
	local etc_dir="/etc/aurora"
	local user_config="$HOME/.config/aurora"
	
	# Vari√°veis XDG
	local xdg_config_home="${XDG_CONFIG_HOME:-$HOME/.config}"
	local xdg_data_home="${XDG_DATA_HOME:-$HOME/.local/share}"
	local xdg_state_home="${XDG_STATE_HOME:-$HOME/.local/state}"
	
	log_info "Instalando Aurora no sistema..."
	
	log_info "Instalando bin√°rio..."
	cat > "$aurora_bin" << 'WRAPPER'
#!/bin/bash
# Aurora Theme Manager - Instala√ß√£o no Sistema
AURORA_ROOT="/usr/local/share/aurora"
export AURORA_ROOT
exec bash "$AURORA_ROOT/src/aurora.sh" "$@"
WRAPPER
	chmod +x "$aurora_bin"
	log_success "Bin√°rio instalado: $aurora_bin"
	
	log_info "Instalando m√≥dulos do sistema..."
	mkdir -p "$system_dir"
	
	cp -r "$project_root/src" "$system_dir/"
	cp -r "$project_root/themes" "$system_dir/"
	
	log_info "Instalando configura√ß√µes globais..."
	mkdir -p "$etc_dir"
	
	if [[ ! -f "$etc_dir/aurora.yml" ]]; then
		cat > "$etc_dir/aurora.yml" << 'CONFIG'
# Configura√ß√µes globais do Aurora
# Pode ser sobrescrito por ~/.config/aurora/aurora.yml

default_theme: "ganache_noir"
check_contrast: true
backup_enabled: true
auto_apply_hooks: false
CONFIG
		log_success "Configura√ß√£o global: $etc_dir/aurora.yml"
	fi
	
	# Criar diret√≥rio para temas globais (opcional, para admin)
	mkdir -p "$etc_dir/themes"
	
	# Criar diret√≥rios do usu√°rio (XDG)
	log_info "Criando estrutura de diret√≥rios do usu√°rio..."
	mkdir -p "$xdg_config_home/aurora"
	mkdir -p "$xdg_data_home/aurora/themes"
	mkdir -p "$xdg_data_home/aurora/backups"
	mkdir -p "$xdg_state_home/aurora"
	
	log_success "Aurora instalado com sucesso!"
	echo ""
	echo "  üìÇ Estrutura instalada:"
	echo "     Bin√°rio:      $aurora_bin"
	echo "     Sistema:      $system_dir"
	echo "       ‚îú‚îÄ‚îÄ src/"
	echo "       ‚îî‚îÄ‚îÄ themes/ (padr√£o)"
	echo "     Global:       $etc_dir"
	echo "       ‚îú‚îÄ‚îÄ aurora.yml"
	echo "       ‚îî‚îÄ‚îÄ themes/ (admin - opcional)"
	echo "     Usu√°rio:      $xdg_config_home/aurora"
	echo "     Dados:        $xdg_data_home/aurora"
	echo "       ‚îú‚îÄ‚îÄ themes/ (personalizados)"
	echo "       ‚îî‚îÄ‚îÄ backups/"
	echo "     Estado:       $xdg_state_home/aurora"
	
	return 0
}

main "$@"
